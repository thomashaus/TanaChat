asyncapi: 2.6.0
info:
  title: TanaChat.ai AsyncAPI
  description: |
    ## Asynchronous Operations for TanaChat.ai

    This AsyncAPI specification describes the real-time messaging patterns used by TanaChat.ai
    for handling background file processing, workspace analysis, and AI workflow integration.

    ## Event Types

    * **File Processing**: Background processing of uploaded Tana JSON files
    * **Analysis Completion**: Real-time notifications when workspace analysis completes
    * **Status Updates**: Progress tracking for long-running AI operations
    * **Integration Events**: MCP server and AI assistant integration events

    ## Message Format

    All messages use JSON format with consistent event metadata and payload structures.

  version: 0.1.0
  contact:
    name: TanaChat.ai Support
    url: https://tanachat.ai
    email: hello@tanachat.ai

servers:
  production:
    url: wss://api.tanachat.ai/ws
    description: Production WebSocket server
  development:
    url: ws://localhost:8000/ws
    description: Development WebSocket server

channels:
  user.{user_id}.files:
    description: User-specific file processing events
    parameters:
      user_id:
        description: User ID for scoping messages
        schema:
          type: string
    subscribe:
      summary: Receive file processing notifications
      operationId: subscribeToFileEvents
      message:
        $ref: '#/components/messages/FileProcessingEvent'

  user.{user_id}.notifications:
    description: General user notifications
    parameters:
      user_id:
        description: User ID for scoping messages
        schema:
          type: string
    subscribe:
      summary: Receive user notifications
      operationId: subscribeToNotifications
      message:
        $ref: '#/components/messages/UserNotification'

  system.events:
    description: System-wide events (admin only)
    subscribe:
      summary: Receive system events
      operationId: subscribeToSystemEvents
      message:
        $ref: '#/components/messages/SystemEvent'

components:
  messages:
    FileProcessingEvent:
      name: FileProcessingEvent
      title: File Processing Event
      summary: Event sent during file processing lifecycle
      contentType: application/json
      payload:
        type: object
        required:
          - event_id
          - event_type
          - timestamp
          - file_id
          - user_id
        properties:
          event_id:
            type: string
            description: Unique event identifier
            example: "evt_123456789"
          event_type:
            type: string
            enum:
              - file.uploaded
              - file.validation_started
              - file.validation_completed
              - file.analysis_started
              - file.analysis_completed
              - file.stored
              - file.processing_failed
              - file.deleted
            description: Type of processing event
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
          file_id:
            type: string
            description: File ID being processed
          user_id:
            type: string
            description: User who owns the file
          filename:
            type: string
            description: Original filename
          status:
            type: string
            enum:
              - pending
              - processing
              - completed
              - failed
            description: Processing status
          progress:
            type: number
            minimum: 0
            maximum: 100
            description: Progress percentage (0-100)
          metadata:
            $ref: '#/components/schemas/FileProcessingMetadata'
          error:
            $ref: '#/components/schemas/ErrorInfo'
            description: Error details if processing failed

    UserNotification:
      name: UserNotification
      title: User Notification
      summary: General notification for user
      contentType: application/json
      payload:
        type: object
        required:
          - notification_id
          - type
          - timestamp
          - user_id
          - title
          - message
        properties:
          notification_id:
            type: string
            description: Unique notification identifier
            example: "notif_987654321"
          type:
            type: string
            enum:
              - info
              - success
              - warning
              - error
            description: Notification type
          timestamp:
            type: string
            format: date-time
            description: Notification timestamp
          user_id:
            type: string
            description: Target user ID
          title:
            type: string
            description: Notification title
            example: "File Upload Complete"
          message:
            type: string
            description: Notification message
            example: "Your Tana file 'project-export.json' has been successfully processed."
          action_url:
            type: string
            description: Optional URL for user action
            example: "/api/tana/files/file-123"
          metadata:
            type: object
            description: Additional notification metadata
            properties:
              file_id:
                type: string
              expires_at:
                type: string
                format: date-time

    SystemEvent:
      name: SystemEvent
      title: System Event
      summary: System-wide event for monitoring
      contentType: application/json
      payload:
        type: object
        required:
          - event_id
          - event_type
          - timestamp
          - severity
        properties:
          event_id:
            type: string
            description: Unique event identifier
          event_type:
            type: string
            enum:
              - system.startup
              - system.shutdown
              - spaces.connection_lost
              - spaces.connection_restored
              - high.load
              - maintenance.scheduled
              - maintenance.started
              - maintenance.completed
            description: Type of system event
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
          severity:
            type: string
            enum:
              - info
              - warning
              - error
              - critical
            description: Event severity level
          message:
            type: string
            description: Event description
          service:
            type: string
            description: Service generating the event
            example: "api-server"
          metrics:
            type: object
            description: Relevant metrics
            properties:
              active_uploads:
                type: integer
              storage_usage_gb:
                type: number
              error_rate:
                type: number

  schemas:
    FileProcessingMetadata:
      type: object
      description: Metadata for file processing operations
      properties:
        file_size_bytes:
          type: integer
          description: File size in bytes
        node_count:
          type: integer
          description: Number of nodes found
        supertag_count:
          type: integer
          description: Number of supertags found
        processing_time_ms:
          type: integer
          description: Processing time in milliseconds
        spaces_path:
          type: string
          description: Path where file was stored
        validation_result:
          type: object
          properties:
            valid:
              type: boolean
            version:
              type: string
            errors:
              type: array
              items:
                type: string

    ErrorInfo:
      type: object
      description: Error information
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Error code
          example: "VALIDATION_FAILED"
        message:
          type: string
          description: Human-readable error message
          example: "File validation failed: Invalid Tana format"
        details:
          type: object
          description: Additional error details
          properties:
            line_number:
              type: integer
            field:
              type: string
            value:
              type: string
        retry_after:
          type: string
          format: date-time
          description: Suggested retry time (if applicable)

  securitySchemes:
    bearerAuth:
      type: httpApiKey
      name: Authorization
      in: header
      description: JWT token for WebSocket authentication