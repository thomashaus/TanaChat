services:
  # LocalStack for S3-compatible storage (replaces S3 for development)
  localstack:
    image: localstack/localstack:latest
    container_name: tanachat-localstack
    ports:
      - "4566:4566"  # LocalStack edge port
      - "4510-4559:4510-4559"  # Service port range
    environment:
      - DEBUG=1
      - SERVICES=s3,sqs,lambda,dynamodb,iam,sts
      - DEFAULT_REGION=us-east-1
      - DATA_DIR=/var/localstack/data
      - HOST_CREDENTIALS_DIR=/var/localstack/credentials
      - HOSTNAME_EXTERNAL=localstack
    volumes:
      - localstack_data:/var/localstack
    networks:
      - tanachat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # www - React frontend
  www:
    build:
      context: ./app
      dockerfile: Dockerfile
    image: tanachat-www:latest
    container_name: tanachat-www
    ports:
      - "3000:80"
    environment:
      - VITE_API_URL=http://localhost:8000
      - VITE_S3_ENDPOINT=http://localhost:4566
      - VITE_S3_BUCKET=tanachat-dev
    depends_on:
      - api
      - localstack
    networks:
      - tanachat-network
    restart: unless-stopped

  # api - FastAPI backend
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    image: tanachat-api:latest
    container_name: tanachat-api
    ports:
      - "8000:8000"
    environment:
      - S3_ACCESS_KEY=test-access-key
      - S3_SECRET_KEY=test-secret-key
      - S3_BUCKET=tanachat-dev
      - S3_REGION=us-east-1
      - S3_ENDPOINT=http://localstack:4566  # Use LocalStack instead of S3
      - API_URL=http://localhost:8000
      - API_SECRET_KEY=dev-secret-key-change-in-production
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRY_DAYS=30
      - DATABASE_URL=sqlite:///./tanachat.db
      - DEBUG=true
      - TANA_API_KEY=${TANA_API_KEY:-}
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - tanachat-network
    volumes:
      - ./api:/app
      - ./files:/app/files
      - ./lib:/app/lib
      - api_data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # mcp - FastMCP server
  mcp:
    build:
      context: ./mcp
      dockerfile: Dockerfile
    image: tanachat-mcp:latest
    container_name: tanachat-mcp
    environment:
      - MCP_SERVER_NAME=tanachat-local
      - MCP_API_TOKEN=dev-mcp-token
      - TANACHAT_API_URL=http://api:8000  # Use Docker network name
      - TANACHAT_TOKEN=dev-api-token
      - TANA_API_KEY=${TANA_API_KEY:-}
    depends_on:
      - api
    networks:
      - tanachat-network
    restart: unless-stopped
    profiles:
      - mcp  # Only start with --profile mcp

  # Redis for caching and session storage
  redis:
    image: redis:7-alpine
    container_name: tanachat-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - tanachat-network
    restart: unless-stopped
    command: redis-server --appendonly yes

  # PostgreSQL for persistent data (optional - can use SQLite)
  postgres:
    image: postgres:15-alpine
    container_name: tanachat-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=tanachat
      - POSTGRES_USER=tanachat
      - POSTGRES_PASSWORD=tanachat123
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - tanachat-network
    restart: unless-stopped
    profiles:
      - postgres  # Only start with --profile postgres

  # Nginx reverse proxy (optional)
  nginx:
    image: nginx:alpine
    container_name: tanachat-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - www
      - api
    networks:
      - tanachat-network
    restart: unless-stopped
    profiles:
      - nginx  # Only start with --profile nginx

volumes:
  localstack_data:
    driver: local
  redis_data:
    driver: local
  postgres_data:
    driver: local
  api_data:
    driver: local

networks:
  tanachat-network:
    name: tanachat-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
