# Docker Compose for DigitalOcean-style local testing
version: '3.8'

services:
  # TanaChat App (Frontend)
  tanachat-app:
    build:
      context: ./app
      dockerfile: Dockerfile.do
    ports:
      - "5173:80"
    environment:
      - NODE_ENV=production
      - VITE_API_URL=http://localhost:8000
    depends_on:
      - tanachat-api
    networks:
      - tanachat-network

  # TanaChat API (FastAPI)
  tanachat-api:
    build:
      context: ./api
    ports:
      - "8000:8000"
    environment:
      - API_SECRET_KEY=test-secret-key-local
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRY_DAYS=30
      - DATABASE_URL=sqlite:///./tanachat.db
      - S3_ACCESS_KEY=test-access-key
      - S3_SECRET_KEY=test-secret-key
      - S3_BUCKET=tanachat-test
      - S3_REGION=nyc3
      - S3_ENDPOINT=http://localhost:4566
      - DEBUG=true
    depends_on:
      - localstack
    networks:
      - tanachat-network
    volumes:
      - ./api:/app
      - api-db:/app/db

  # TanaChat MCP Server
  tanachat-mcp:
    build:
      context: ./mcp
      dockerfile: Dockerfile.do
    ports:
      - "8001:8000"
    environment:
      - PYTHONPATH=/app
      - TANA_API_KEY=test-tana-key
      - S3_ACCESS_KEY=test-access-key
      - S3_SECRET_KEY=test-secret-key
      - S3_BUCKET=tanachat-test
      - S3_REGION=nyc3
      - S3_ENDPOINT=http://localhost:4566
    depends_on:
      - localstack
    networks:
      - tanachat-network

  # LocalStack for S3/Spaces simulation
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
      - "4571:4571"
    environment:
      - SERVICES=s3
      - DEBUG=1
      - DATA_DIR=/tmp/localstack/data
    volumes:
      - localstack-data:/tmp/localstack
      - ./scripts/seed-samples.sh:/docker-entrypoint-initaws.d/seed-samples.sh
    networks:
      - tanachat-network

  # PostgreSQL (optional - for production testing)
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=tanachat
      - POSTGRES_USER=tanachat
      - POSTGRES_PASSWORD=tanachat123
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - tanachat-network
    profiles:
      - postgres

volumes:
  api-db:
  localstack-data:
  postgres-data:

networks:
  tanachat-network:
    driver: bridge